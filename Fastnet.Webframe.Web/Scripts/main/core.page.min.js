var t$m=null;(function(n){var t,i;n.core$page={toolbar:null,pageEditor:null,isEditing:!1,options:null,panelData:{Access:null,EditablePanels:[{pageId:null,selector:".CentrePanel",menuMasterId:null,menu:null},{pageId:null,selector:".BannerPanel",menuMasterId:null,menu:null},{pageId:null,selector:".LeftPanel",menuMasterId:null,menu:null},{pageId:null,selector:".RightPanel",menuMasterId:null,menu:null}],MenuPanel:{menuList:[]}},Init:function(){function r(){t.ParkAllMenus();t.pageEditor.LoadEditors()}function u(){var n=t.pageEditor.UnloadEditors();n&&t.RestoreAllMenus()}t=this;i=n.fastnet$utilities;t.toolbar=PageToolbar.get();t.toolbar.addHandler("toolbar-opened",r);t.toolbar.addHandler("exit-edit-mode",u);t.pageEditor=PageEditor.get();t.pageEditor.SetChangePageHandler(function(n){i.Debug("Editor asked for new page {0}",n.url);t.GotoInternalLink(n.url)});n(window).bind("popstate",function(){navigator.appVersion.toLowerCase().indexOf("safari")===-1&&(location.href=location.href)})},RestoreAllMenus:function(){n.each(t.panelData.EditablePanels,function(n,t){t.menu!==null&&t.menu.restore()});n.each(t.panelData.MenuPanel.menuList,function(n,t){t.restore()})},ParkAllMenus:function(){n.each(t.panelData.EditablePanels,function(n,t){t.menu!==null&&t.menu.park()});n.each(t.panelData.MenuPanel.menuList,function(n,t){t.park()})},FindEditablePanel:function(i){var r=null;return n.each(t.panelData.EditablePanels,function(n,t){if(t.selector===i)return r=t,!1}),r},CreateMenus:function(r){function u(r,u,f){var e=i.Format("pageapi/menu/{0}",u.Id);n.when(i.AjaxGet({url:e})).then(function(i){var e=Menu.get(),o,h,s;t$m=e;o=n.extend({menuClasses:[u.Name,u.ClassName]},f);h=e.create(r,i,o);r===".MenuPanel"?t.panelData.MenuPanel.menuList.push(e):(s=t.FindEditablePanel(r),s.menu=e)})}n.each(r,function(n,t){switch(t.Panel){case"menupanel":u(".MenuPanel",t);break;case"bannerpanel":u(".BannerPanel",t);break;case"leftpanel":u(".LeftPanel",t,{direction:"vertical"});break;case"rightpanel":u(".RightPanel",t,{direction:"vertical"})}})},GotoInternalLink:function(i){switch(i){case"/home":case"login":t.ShowDialog("login");break;case"/register":case"/recoverpassword":case"/studio":case"/membership":n.fastnet$account.AccountOperation(i);break;case"/userprofile":t.ShowDialog("userprofile");break;default:i.startsWith("page/")&&(t.SetPage(i.substring(5)),window.history.pushState({href:i},null,i))}},IsLinkInternal:function(i){function e(t){var i=!1;return n.each(u,function(n,r){return i=t===r,i?!1:void 0}),i}var r=!1,u,f;return i=t.StandardiseUrl(i),u=["login","logon","login","logoff","register","recoverpassword"],f=!(i.startsWith("http")||i.startsWith("file")||i.startsWith("mailto")),f&&(r=e(i)?!0:i.startsWith("page/")||i.startsWith("document/")||i.startsWith("video/")),r},ShowDialog:function(t){var r=i.Format("model/{0}",t);n.when(i.AjaxGet({url:r})).then(function(t){n.fastnet$account.Start(t,function(){})})},StandardiseUrl:function(t){var i=n("head base").attr("href");return t=t.toLowerCase(),t.startsWith(i)&&(t=t.substring(i.length,t.length-i.length)),t.startsWith("http")||t.startsWith("file")||t.startsWith("mailto")||t.startsWith("/")&&(t=t.substring(1)),t},LoadStartPage:function(r){var u=r;n.when(i.AjaxGet({url:"pageapi/menumaster"})).then(function(n){t.CreateMenus(n);t.SetPage(u);t.QueryAuthentication()})},ParallelCalls:function(){n.when(i.AjaxGet({url:"main/special/echo/2"}),i.AjaxGet({url:"main/special/echo/5"})).then(function(){alert("both done");i.MessageBox("#exampleModal")})},QueryAuthentication:function(){n.when(i.AjaxGet({url:"account/currentuser"},!0)).then(function(t){if(t.Authenticated){var r=t.EmailAddress,i=t.Name;n(".login-name").html(i).removeClass("hide")}else n(".login-name").addClass("hide").html("")})},SetPage:function(r){n.when(i.AjaxGet({url:"pageapi/sidepages/"+r}),i.AjaxGet({url:"pageapi/page/access/"+r})).then(function(i,u){var f=i[0],e=r,o=u[0].Access;t.UpdatePanel(t.FindEditablePanel(".BannerPanel"),f.Banner);t.UpdatePanel(t.FindEditablePanel(".LeftPanel"),f.Left);t.UpdatePanel(t.FindEditablePanel(".RightPanel"),f.Right);t.UpdatePanel(t.FindEditablePanel(".CentrePanel"),{Id:e,Menu:null});n(".SitePanel .login-status").off();n(".SitePanel .login-status").on("click",function(){t.GotoInternalLink("/userprofile")});t.panelData.Access=o;t.panelData.Access=="editallowed"?t.toolbar.show():t.toolbar.hide()})},Start:function(r){if(i.Debug("pathname = {0}, {1}",location.pathname,location.href),t.options=r,t.options.ClientSideLog&&n.fastnet$utilities.EnableClientSideLog(),t.LoadStartPage(r.StartPage),r.HasAction&&r.ShowDialog){var u=location.href,f=i.Format("{0}//{1}",location.protocol,location.host);window.history.pushState({href:u},null,f);n.fastnet$account.Start(r,function(){t.QueryAuthentication()})}},ClearContent:function(t){var r=t.selector.substr(1).toLowerCase(),u=i.Format("{0}-style",r);n("head").find("#"+u).remove();n(t).empty();t.pageId==null;t.Menu=null},SetContent:function(r,u){var s=u.styleList,l=u.html,o,e,c;if(typeof s!="string"){var e=r.selector.substr(1).toLowerCase(),h=i.Format("{0}-style",e),f=i.Format("<style id='{0}'>",h);n.each(s,function(t,u){f+=i.Format("{0} {1}",r.selector,u.Selector);f+=" {";n.each(u.Rules,function(n,t){f+=t+"; "});f+="} "});f+="<\/style>";n("head").find("#"+h).remove();n("head").append(n(f))}n(r.selector).off();o=n(l);o.find("a").on("click",function(i){var r=n(this).attr("href");t.IsLinkInternal(r)&&(i.preventDefault(),r=t.StandardiseUrl(r),t.GotoInternalLink(r))});e=r.selector.substr(1).toLowerCase();n(r.selector).empty().append(o);n(r.selector).attr("data-page-id",u.pageId);n(r.selector).attr("data-panel",e);n(r.selector).attr("data-location",u.location);r.menuMasterId!=null&&(i.Debug("Panel selector {0} needs menu id {1}",r.selector,r.menuMasterId),c=i.Format("pageapi/menumaster/{0}",r.menuMasterId),n.when(i.AjaxGet({url:c})).then(function(n){t.CreateMenus(n)}))},UpdatePanel:function(r,u){r.pageId!==u.Id&&(u.Id!=null?n.when(i.AjaxGet({url:"pageapi/page/"+u.Id})).then(function(n){t.SetContent(r,{access:n.Access,styleList:n.HtmlStyles,html:n.HtmlText,pageId:n.PageId,location:n.Location})}):t.ClearContent(r),r.pageId=u.Id,r.menuMasterId=u.Menu)},LoadEditor:function(i){if(!n.core$editor){var r=[];n.each(["scripts/jquery-ui-1.11.4.min.js","scripts/datatables/jquery.datatables.js","scripts/tinymce/tinymce.js","scripts/dropzone/dropzone.js","scripts/fastnet/fastnet.contextmenu.js","scripts/fastnet/fastnet.treeview.js","scripts/main/core.editor.js"],function(n,i){r.push(t.AjaxGetScript({url:i}))});n.when.apply(n,r).then(function(){i()})}},AjaxGetScript:function(t){return n(".ajax-error-message").empty(),n.ajax({url:"/"+t.url,dataType:"script",type:"GET",cache:!0,crossDomain:!0})}};n(function(){n.core$page.Init()})})(jQuery);
//# sourceMappingURL=core.page.min.js.map
