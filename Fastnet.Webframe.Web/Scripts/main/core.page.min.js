(function(n){var t,i;n.core$page={toolbar:null,pageEditor:null,isEditing:!1,options:null,currentPages:{centreId:null,bannerId:null,leftId:null,rightId:null},Init:function(){t=this;i=n.fastnet$utilities;t.toolbar=PageToolbar.get();t.pageEditor=PageEditor.get();n(window).bind("popstate",function(){navigator.appVersion.toLowerCase().indexOf("safari")===-1&&(location.href=location.href)})},ClearContent:function(t){var r=i.Format("{0}-style",t.toLowerCase());n("head").find("#"+r).remove();n("."+t).empty()},CreateMenus:function(t){var i=n(t),r=i.first();r.addClass("nav navbar-nav");n(".MenuPanel").empty().append(i)},GotoInternalLink:function(i){switch(i){case"/home":case"login":t.ShowDialog("login");break;case"/register":case"/recoverpassword":case"/studio":case"/membership":n.fastnet$account.AccountOperation(i);break;case"/userprofile":t.ShowDialog("userprofile");break;default:i.startsWith("page/")&&(t.SetPage(i.substring(5)),window.history.pushState({href:i},null,i))}},IsLinkInternal:function(i){function e(t){var i=!1;return n.each(u,function(n,r){return i=t===r,i?!1:void 0}),i}var r=!1,u,f;return i=t.StandardiseUrl(i),u=["home","login","logon","login","logoff","register","recoverpassword","studio","membership"],f=!(i.startsWith("http")||i.startsWith("file")||i.startsWith("mailto")),f&&(r=e(i)?!0:i.startsWith("page/")||i.startsWith("document/")||i.startsWith("video/")),r},ShowDialog:function(t){var r=i.Format("model/{0}",t);n.when(i.AjaxGet({url:r})).then(function(t){n.fastnet$account.Start(t,function(){})})},StandardiseUrl:function(t){var i=n("head base").attr("href");return t=t.toLowerCase(),t.startsWith(i)&&(t=t.substring(i.length,t.length-i.length)),t.startsWith("http")||t.startsWith("file")||t.startsWith("mailto")||t.startsWith("/")&&(t=t.substring(1)),t},LoadStartPage:function(r){var u="",f;u=typeof r=="undefined"||r===null||r===""?"pageapi/home":i.Format("pageapi/page/{0}",r);f="pageapi/home";n.when(i.AjaxGet({url:"pageapi/menuinfo"}),i.AjaxGet({url:u})).then(function(n,i){var r=n[0],e=i[0],o=r.Visible,u,f;o&&(u=r.MenuHtml,t.CreateMenus(u));f=e.PageId;t.SetPage(f);t.QueryAuthentication()})},ParallelCalls:function(){n.when(i.AjaxGet({url:"main/special/echo/2"}),i.AjaxGet({url:"main/special/echo/5"})).then(function(){alert("both done");i.MessageBox("#exampleModal")})},QueryAuthentication:function(){n.when(i.AjaxGet({url:"account/currentuser"},!0)).then(function(t){if(t.Authenticated){var r=t.EmailAddress,i=t.Name;n(".login-name").html(i).removeClass("hide")}else n(".login-name").addClass("hide").html("")})},SetPage:function(r){n.when(i.AjaxGet({url:"pageapi/panelinfo/"+r}),i.AjaxGet({url:"pageapi/page/canedit/"+r})).then(function(i,u){var f=i[0],e=u[0].CanEdit,o=r,s=f.BannerPanel.Visible?f.BannerPanel.PageId:null,h=f.LeftPanel.Visible?f.LeftPanel.PageId:null,c=f.RightPanel.Visible?f.RightPanel.PageId:null;t.currentPages.bannerId=t.UpdatePanel("BannerPanel",t.currentPages.bannerId,s);t.currentPages.leftId=t.UpdatePanel("LeftPanel",t.currentPages.leftId,h);t.currentPages.rightId=t.UpdatePanel("RightPanel",t.currentPages.rightId,c);t.currentPages.centreId=t.UpdatePanel("CentrePanel",t.currentPages.centreId,o);n(".SitePanel .login-status").off();n(".SitePanel .login-status").on("click",function(){t.GotoInternalLink("/userprofile")});e?t.toolbar.show():t.toolbar.hide()})},SetContent:function(r,u){var h=u.styleList,c=u.html,o,f,s,e;typeof h!="string"&&(o=i.Format("{0}-style",r.toLowerCase()),f=i.Format("<style id='{0}'>",o),n.each(h,function(t,u){f+=i.Format(".{0} {1}",r,u.Selector);f+=" {";n.each(u.Rules,function(n,t){f+=t+"; "});f+="} "}),f+="<\/style>",n("head").find("#"+o).remove(),n("head").append(n(f)));n("."+r).off();s=n(c);s.find("a").on("click",function(i){var r=n(this).attr("href");t.IsLinkInternal(r)&&(i.preventDefault(),r=t.StandardiseUrl(r),t.GotoInternalLink(r))});e="."+r;n(e).empty().append(s);n(e).attr("data-page-id",u.pageId);n(e).attr("data-panel",r)},Start:function(r){if(i.Debug("pathname = {0}, {1}",location.pathname,location.href),t.options=r,t.options.ClientSideLog&&n.fastnet$utilities.EnableClientSideLog(),t.LoadStartPage(r.StartPage),r.HasAction&&r.ShowDialog){var u=location.href,f=i.Format("{0}//{1}",location.protocol,location.host);window.history.pushState({href:u},null,f);n.fastnet$account.Start(r,function(){t.QueryAuthentication()})}},UpdatePanel:function(r,u,f){if(u!==f)return f!=null?n.when(i.AjaxGet({url:"pageapi/page/"+f})).then(function(n){t.SetContent(r,{styleList:n.HtmlStyles,html:n.HtmlText,pageId:n.PageId})}):t.ClearContent(r),f},LoadEditor:function(i){if(!n.core$editor){var r=[];n.each(["scripts/jquery-ui-1.11.4.min.js","scripts/datatables/jquery.datatables.js","scripts/tinymce/tinymce.js","scripts/dropzone/dropzone.js","scripts/fastnet/fastnet.contextmenu.js","scripts/fastnet/fastnet.treeview.js","scripts/main/core.editor.js"],function(n,i){r.push(t.AjaxGetScript({url:i}))});n.when.apply(n,r).then(function(){i()})}},AjaxGetScript:function(t){return n(".ajax-error-message").empty(),n.ajax({url:"/"+t.url,dataType:"script",type:"GET",cache:!0,crossDomain:!0})}};n(function(){n.core$page.Init()})})(jQuery);
//# sourceMappingURL=core.page.min.js.map
