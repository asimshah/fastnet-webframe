(function(n){var t,i;n.core$page={toolbar:null,pageEditor:null,isEditing:!1,options:null,currentPage:{Access:null,CentrePanel:{id:null,selector:".CentrePanel"},BannerPanel:{id:null,selector:".BannerPanel"},LeftPanel:{id:null,selector:".LeftPanel"},RightPanel:{id:null,selector:".RightPanel"}},Init:function(){t=this;i=n.fastnet$utilities;t.toolbar=PageToolbar.get();t.pageEditor=PageEditor.get();t.pageEditor.SetChangePageHandler(function(n){i.Debug("Editor asked for new page {0}",n.url);t.GotoInternalLink(n.url)});n(window).bind("popstate",function(){navigator.appVersion.toLowerCase().indexOf("safari")===-1&&(location.href=location.href)})},CreateMenus:function(t){var i=n(t),r=i.first();r.addClass("nav navbar-nav");n(".MenuPanel").empty().append(i)},GotoInternalLink:function(i){switch(i){case"/home":case"login":t.ShowDialog("login");break;case"/register":case"/recoverpassword":case"/studio":case"/membership":n.fastnet$account.AccountOperation(i);break;case"/userprofile":t.ShowDialog("userprofile");break;default:i.startsWith("page/")&&(t.SetPage(i.substring(5)),window.history.pushState({href:i},null,i))}},IsLinkInternal:function(i){function e(t){var i=!1;return n.each(u,function(n,r){return i=t===r,i?!1:void 0}),i}var r=!1,u,f;return i=t.StandardiseUrl(i),u=["home","login","logon","login","logoff","register","recoverpassword","studio","membership"],f=!(i.startsWith("http")||i.startsWith("file")||i.startsWith("mailto")),f&&(r=e(i)?!0:i.startsWith("page/")||i.startsWith("document/")||i.startsWith("video/")),r},ShowDialog:function(t){var r=i.Format("model/{0}",t);n.when(i.AjaxGet({url:r})).then(function(t){n.fastnet$account.Start(t,function(){})})},StandardiseUrl:function(t){var i=n("head base").attr("href");return t=t.toLowerCase(),t.startsWith(i)&&(t=t.substring(i.length,t.length-i.length)),t.startsWith("http")||t.startsWith("file")||t.startsWith("mailto")||t.startsWith("/")&&(t=t.substring(1)),t},LoadStartPage:function(r){var u=r;n.when(i.AjaxGet({url:"pageapi/menuinfo"})).then(function(n){var r=n,i;!1&&(i=r.MenuHtml,t.CreateMenus(i));t.SetPage(u);t.QueryAuthentication()})},ParallelCalls:function(){n.when(i.AjaxGet({url:"main/special/echo/2"}),i.AjaxGet({url:"main/special/echo/5"})).then(function(){alert("both done");i.MessageBox("#exampleModal")})},QueryAuthentication:function(){n.when(i.AjaxGet({url:"account/currentuser"},!0)).then(function(t){if(t.Authenticated){var r=t.EmailAddress,i=t.Name;n(".login-name").html(i).removeClass("hide")}else n(".login-name").addClass("hide").html("")})},SetPage:function(r){n.when(i.AjaxGet({url:"pageapi/sidepages/"+r}),i.AjaxGet({url:"pageapi/page/access/"+r})).then(function(i,u){var f=i[0],e=r,o=f.Banner,s=f.Left,h=f.Right,c=u[0].Access;t.UpdatePanel(t.currentPage.BannerPanel,o);t.UpdatePanel(t.currentPage.LeftPanel,s);t.UpdatePanel(t.currentPage.RightPanel,h);t.UpdatePanel(t.currentPage.CentrePanel,e);n(".SitePanel .login-status").off();n(".SitePanel .login-status").on("click",function(){t.GotoInternalLink("/userprofile")});t.currentPage.Access=c;t.currentPage.Access=="editallowed"?t.toolbar.show():t.toolbar.hide()})},Start:function(r){if(i.Debug("pathname = {0}, {1}",location.pathname,location.href),t.options=r,t.options.ClientSideLog&&n.fastnet$utilities.EnableClientSideLog(),t.LoadStartPage(r.StartPage),r.HasAction&&r.ShowDialog){var u=location.href,f=i.Format("{0}//{1}",location.protocol,location.host);window.history.pushState({href:u},null,f);n.fastnet$account.Start(r,function(){t.QueryAuthentication()})}},ClearContent:function(t){var r=t.selector.substr(1).toLowerCase(),u=i.Format("{0}-style",r);n("head").find("#"+u).remove();n(t).empty()},SetContent:function(r,u){var s=u.styleList,c=u.html,o,e;if(typeof s!="string"){var e=r.selector.substr(1).toLowerCase(),h=i.Format("{0}-style",e),f=i.Format("<style id='{0}'>",h);n.each(s,function(t,u){f+=i.Format("{0} {1}",r.selector,u.Selector);f+=" {";n.each(u.Rules,function(n,t){f+=t+"; "});f+="} "});f+="<\/style>";n("head").find("#"+h).remove();n("head").append(n(f))}n(r.selector).off();o=n(c);o.find("a").on("click",function(i){var r=n(this).attr("href");t.IsLinkInternal(r)&&(i.preventDefault(),r=t.StandardiseUrl(r),t.GotoInternalLink(r))});e=r.selector.substr(1).toLowerCase();n(r.selector).empty().append(o);n(r.selector).attr("data-page-id",u.pageId);n(r.selector).attr("data-panel",e);n(r.selector).attr("data-location",u.location)},UpdatePanel:function(r,u){r.id!==u&&(u!=null?n.when(i.AjaxGet({url:"pageapi/page/"+u})).then(function(n){t.SetContent(r,{access:n.Access,styleList:n.HtmlStyles,html:n.HtmlText,pageId:n.PageId,location:n.Location})}):t.ClearContent(r),r.id=u)},LoadEditor:function(i){if(!n.core$editor){var r=[];n.each(["scripts/jquery-ui-1.11.4.min.js","scripts/datatables/jquery.datatables.js","scripts/tinymce/tinymce.js","scripts/dropzone/dropzone.js","scripts/fastnet/fastnet.contextmenu.js","scripts/fastnet/fastnet.treeview.js","scripts/main/core.editor.js"],function(n,i){r.push(t.AjaxGetScript({url:i}))});n.when.apply(n,r).then(function(){i()})}},AjaxGetScript:function(t){return n(".ajax-error-message").empty(),n.ajax({url:"/"+t.url,dataType:"script",type:"GET",cache:!0,crossDomain:!0})}};n(function(){n.core$page.Init()})})(jQuery);
//# sourceMappingURL=core.page.min.js.map
